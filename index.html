<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <!-- <link rel="stylesheet" href="styles.css" /> -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
      integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
      integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"
      integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>
    <script type="text/javascript">
      // More API functions here:
      // https://github.com/googlecreativelab/teachablemachine-community/tree/master/libraries/pose

      // the link to your model provided by Teachable Machine export panel
      const URL = "./TestFolder/TestTeachableModel/my_model/";
      let model, webcam, ctx, labelContainer, maxPredictions;

      let group = [];
      let toggle = false;

      async function init() {
        toggle = true;
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        // load the model and metadata
        // Refer to tmImage.loadFromFiles() in the API to support files from a file picker
        // Note: the pose library adds a tmPose object to your window (window.tmPose)

        model = await tmPose.load(modelURL, metadataURL);
        // you need to create File objects, like with file input elements (<input type="file" ...>)
        // const uploadModel = document.getElementById('upload-model');
        // const uploadWeights = document.getElementById('upload-weights');
        // const uploadMetadata = document.getElementById('upload-metadata');
        // model = await tmPose.loadFromFiles(uploadModel.files[0], uploadWeights.files[0], uploadMetadata.files[0])
        maxPredictions = model.getTotalClasses();

        // Convenience function to setup a webcam
        let mql = window.matchMedia("(max-width: 570px)");
        const size = !mql ? window.innerWidth * 0.6 : window.innerHeight * 0.48;
        const flip = true; // whether to flip the webcam
        webcam = new tmPose.Webcam(size, size, flip); // width, height, flip
        await webcam.setup(); // request access to the webcam
        await webcam.play();
        window.requestAnimationFrame(loop);

        // append/get elements to the DOM
        const canvas = document.getElementById("canvas");
        canvas.width = !mql
          ? window.innerWidth * 0.5
          : window.innerHeight * 0.45;
        canvas.height = !mql
          ? window.innerWidth * 0.5
          : window.innerHeight * 0.45;
        ctx = canvas.getContext("2d");
        labelContainer = document.getElementById("label-container");
        for (let i = 0; i < maxPredictions; i++) {
          // and class labels
          labelContainer.appendChild(document.createElement("div"));
        }
      }

      async function loop(timestamp) {
        console.log(timestamp);
        webcam.update(); // update the webcam frame

        await predict();
        if (toggle) {
          window.requestAnimationFrame(loop);
        }
      }

      async function predict() {
        // Prediction #1: run input through posenet
        // estimatePose can take in an image, video or canvas html element
        const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
        // Prediction 2: run input through teachable machine classification model
        const prediction = await model.predict(posenetOutput);
        // console.log(group)
        if (group.length < 100) {
          group.push(prediction);
        } else {
          group.shift();
          group.push(prediction);
        }
        checkPosture(group);
        // console.log(group)
        for (let i = 0; i < maxPredictions; i++) {
          const classPrediction =
            prediction[i].className +
            ": " +
            prediction[i].probability.toFixed(2);
          // labelContainer.childNodes[i].innerHTML = classPrediction;
        }

        // finally draw the poses
        drawPose(pose);
      }
      function notifyMe(message) {
        // Let's check if the browser supports notifications
        const startover = function () {
          // console.log('NOTIFICATION CLICKed')
          toggle = true;
          // console.log(toggle)
          window.requestAnimationFrame(loop);
          group = [];
        };
        if (!("Notification" in window)) {
          alert("This browser does not support desktop notification");
        }

        // Let's check whether notification permissions have already been granted
        else if (Notification.permission === "granted") {
          // If it's okay let's create a notification
          var title = "Posture";
          icon = "https://homepages.cae.wisc.edu/~ece533/images/airplane.png";
          var body =
            message + ". Please sit in correctly and click this notification";
          var tag = "pose-bot";
          var notification = new Notification(title, { body, icon, tag });
        }

        // Otherwise, we need to ask the user for permission
        else if (Notification.permission !== "denied") {
          Notification.requestPermission().then(function (permission) {
            // If the user accepts, let's create a notification
            if (permission === "granted") {
              var notification = new Notification(title, { body, icon, tag });
            }
          });
        }

        notification.onclick = startover;
        notification.onclose = startover;

        // At last, if the user has denied notifications, and you
        // want to be respectful there is no need to bother them any more.
      }
      function checkPosture(posturegroup) {
        //group
        console.log(group);
        goodposture = (
          posturegroup.reduce((sum, data) => {
            return sum + data[0].probability;
          }, 0) / 100
        ).toFixed(3);
        badposture = (
          posturegroup.reduce((sum, data) => {
            return sum + data[1].probability;
          }, 0) / 100
        ).toFixed(3);
        nearscreen = (
          posturegroup.reduce((sum, data) => {
            return sum + data[2].probability;
          }, 0) / 100
        ).toFixed(3);

        // console.log('good: ',goodposture,' bad: ', badposture)
        // document.getElementById('good').innerHTML = 'Good: ' + goodposture
        // document.getElementById('bad').innerHTML = 'Bad: ' + badposture

        console.log({ goodposture, badposture, nearscreen });

        if (badposture >= 0.9) {
          // console.log('bad posture')
          toggle = false;
          group = [];
          notifyMe("Correct your posture");
        }

        if (nearscreen >= 0.9) {
          // console.log('bad posture')
          toggle = false;
          group = [];
          notifyMe("get away from screen");
        }
      }

      function drawPose(pose) {
        if (webcam.canvas) {
          ctx.drawImage(webcam.canvas, 0, 0);
          // draw the keypoints and skeleton
          if (pose) {
            const minPartConfidence = 0.5;
            tmPose.drawKeypoints(pose.keypoints, minPartConfidence, ctx);
            tmPose.drawSkeleton(pose.keypoints, minPartConfidence, ctx);
          }
        }
      }
    </script>
  </head>
  <style>
    * {
      /* border: 1px dotted green; */
    }
    main > img {
      height: 300px;
    }
  </style>
  <body class="" style="background-color: #232128">
    <div class="landing text-light">
      <!-- Header with logo position: sticky/fixed -->
      <header class="text-center">
        <div class="logo-div">
          <img src="./assets//img/logo.jpeg" alt="Logo" class="img img-fluid" />
        </div>
      </header>

      <!-- Main screen -->
      <main>
        <div class="text-center m-1">
          <div id="demo" class="carousel slide my-3" data-ride="carousel">
            <ul class="carousel-indicators">
              <li data-target="#demo" data-slide-to="0" class="active"></li>
              <li data-target="#demo" data-slide-to="1"></li>
              <li data-target="#demo" data-slide-to="2"></li>
            </ul>
            <div class="carousel-inner">
              <div class="carousel-item active">
                <img
                  src="https://media.istockphoto.com/photos/man-is-bent-over-tabletbad-sitting-posture-at-work-picture-id187491090?k=6&m=187491090&s=612x612&w=0&h=FzREE8-aVN4xTIHHtfNZ8ADE8uMQmPppMjGdJYm7bQs="
                  alt="Los Angeles"
                />
                <div class="carousel-caption">
                  <!-- <h3 class="text-dark">Back pain?</h3>
                  <p class="text-dark">
                    The reason could be bad sitting posture
                  </p> -->
                </div>
              </div>
              <div class="carousel-item">
                <img
                  src="https://buffer.com/resources/content/images/resources/wp-content/uploads/2013/11/Screen-Shot-2013-11-11-at-8.09.23-AM.png"
                  alt="Chicago"
                />
                <div class="carousel-caption">
                  <!-- <h3>Chicago</h3>
                  <p>Thank you, Chicago!</p> -->
                </div>
              </div>
              <div class="carousel-item">
                <img
                  src="https://scitechdaily.com/images/Human-Spinal-Cord.jpg"
                  width="80%"
                  alt="New York"
                />
                <div class="carousel-caption">
                  <!-- <h3>New York</h3>
                  <p>We love the Big Apple!</p> -->
                </div>
              </div>
              <div class="carousel-item">
                <img
                  src="https://news.umich.edu/wp-content/uploads/2019/07/an-epipen-for-spinal-cord-injuries-1.jpg"
                  alt="Chicago"
                />
                <div class="carousel-caption">
                  <!-- <h3>Chicago</h3>
                  <p>Thank you, Chicago!</p> -->
                </div>
              </div>
            </div>
            <a class="carousel-control-prev" href="#demo" data-slide="prev">
              <span class="carousel-control-prev-icon"></span>
            </a>
            <a class="carousel-control-next" href="#demo" data-slide="next">
              <span class="carousel-control-next-icon"></span>
            </a>
          </div>
          <canvas id="canvas"></canvas>
        </div>
      </main>
      <div class="masthead container text-center">
        <div class="m-4">
          <button
            class="font-weight-bold btn btn-primary text-light px-5"
            style="border-radius: 9999px"
            onclick="init()"
          >
            Monitor me.
          </button>
          <!-- Button trigger modal -->
          <button
            type="button"
            class="btn btn-primary m-4 font-weight-bold px-5"
            data-toggle="modal"
            data-target="#exampleModal"
            style="border-radius: 999px"
          >
            Learn More.
          </button>

          <!-- Modal -->
          <div
            class="modal fade"
            id="exampleModal"
            tabindex="-1"
            role="dialog"
            aria-labelledby="exampleModalLabel"
            aria-hidden="true"
          >
            <div
              class="modal-dialog modal-dialog-centered modal-dialog-scrollable"
              role="document"
            >
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">
                    Modal title
                  </h5>
                  <button
                    type="button"
                    class="close"
                    data-dismiss="modal"
                    aria-label="Close"
                  >
                    <span aria-hidden="true">×</span>
                  </button>
                </div>
                <div class="modal-body">
                  <div id="demo" class="carousel slide" data-ride="carousel">
                    <ul class="carousel-indicators">
                      <li
                        data-target="#demo"
                        data-slide-to="0"
                        class="active"
                      ></li>
                      <li data-target="#demo" data-slide-to="1"></li>
                      <li data-target="#demo" data-slide-to="2"></li>
                    </ul>
                    <div class="carousel-inner">
                      <div class="carousel-item active">
                        <img
                          src="la.jpg"
                          alt="Los Angeles"
                          width="1100"
                          height="500"
                        />
                        <div class="carousel-caption">
                          <h3>Los Angeles</h3>
                          <p>We had such a great time in LA!</p>
                        </div>
                      </div>
                      <div class="carousel-item">
                        <img
                          src="chicago.jpg"
                          alt="Chicago"
                          width="1100"
                          height="500"
                        />
                        <div class="carousel-caption">
                          <h3>Chicago</h3>
                          <p>Thank you, Chicago!</p>
                        </div>
                      </div>
                      <div class="carousel-item">
                        <img
                          src="ny.jpg"
                          alt="New York"
                          width="1100"
                          height="500"
                        />
                        <div class="carousel-caption">
                          <h3>New York</h3>
                          <p>We love the Big Apple!</p>
                        </div>
                      </div>
                    </div>
                    <a
                      class="carousel-control-prev"
                      href="#demo"
                      data-slide="prev"
                    >
                      <span class="carousel-control-prev-icon"></span>
                    </a>
                    <a
                      class="carousel-control-next"
                      href="#demo"
                      data-slide="next"
                    >
                      <span class="carousel-control-next-icon"></span>
                    </a>
                  </div>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-dismiss="modal"
                  >
                    Close
                  </button>
                  <button type="button" class="btn btn-primary">
                    Save changes
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Canvas with video  -->
      <!-- Posture Output  -->
    </div>
  </body>
</html>
